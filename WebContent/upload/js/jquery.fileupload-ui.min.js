(function(d){"function"===typeof define&&define.amd?define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],d):d(window.jQuery,window.tmpl,window.loadImage)})(function(d,h,k){d.widget("blueimp.fileupload",d.blueimp.fileupload,{options:{autoUpload:!0,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:1E7,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplateId:"template-upload",
downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",add:function(a,b){var c=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),f=c.options,e=b.files;d(this).fileupload("process",b).done(function(){c._adjustMaxNumberOfFiles(-e.length);b.maxNumberOfFilesAdjusted=!0;b.files.valid=b.isValidated=c._validate(e);b.context=c._renderUpload(e).data("data",b);f.filesContainer[f.prependFiles?"prepend":"append"](b.context);c._renderPreviews(b);c._forceReflow(b.context);
c._transition(b.context).done(function(){!1!==c._trigger("added",a,b)&&((f.autoUpload||b.autoUpload)&&!1!==b.autoUpload&&b.isValidated)&&b.submit()})})},send:function(a,b){var c=d(this).data("blueimp-fileupload")||d(this).data("fileupload");if(!b.isValidated&&(b.maxNumberOfFilesAdjusted||(c._adjustMaxNumberOfFiles(-b.files.length),b.maxNumberOfFilesAdjusted=!0),!c._validate(b.files)))return!1;b.context&&(b.dataType&&"iframe"===b.dataType.substr(0,6))&&b.context.find(".progress").addClass(!d.support.transition&&
"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%");return c._trigger("sent",a,b)},done:function(a,b){var c=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),f=c._getFilesFromResponse(b),e,g;b.context?b.context.each(function(g){var l=f[g]||{error:"Empty file upload result"},h=c._addFinishedDeferreds();l.error&&c._adjustMaxNumberOfFiles(1);c._transition(d(this)).done(function(){var f=d(this);e=c._renderDownload([l]).replaceAll(f);c._forceReflow(e);c._transition(e).done(function(){b.context=
d(this);c._trigger("completed",a,b);c._trigger("finished",a,b);h.resolve()})})}):(f.length&&(d.each(f,function(a,d){b.maxNumberOfFilesAdjusted&&d.error?c._adjustMaxNumberOfFiles(1):!b.maxNumberOfFilesAdjusted&&!d.error&&c._adjustMaxNumberOfFiles(-1)}),b.maxNumberOfFilesAdjusted=!0),e=c._renderDownload(f).appendTo(c.options.filesContainer),c._forceReflow(e),g=c._addFinishedDeferreds(),c._transition(e).done(function(){b.context=d(this);c._trigger("completed",a,b);c._trigger("finished",a,b);g.resolve()}))},
fail:function(a,b){var c=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),f,e;b.maxNumberOfFilesAdjusted&&c._adjustMaxNumberOfFiles(b.files.length);b.context?b.context.each(function(g){if("abort"!==b.errorThrown){var j=b.files[g];j.error=j.error||b.errorThrown||!0;e=c._addFinishedDeferreds();c._transition(d(this)).done(function(){var g=d(this);f=c._renderDownload([j]).replaceAll(g);c._forceReflow(f);c._transition(f).done(function(){b.context=d(this);c._trigger("failed",a,b);c._trigger("finished",
a,b);e.resolve()})})}else e=c._addFinishedDeferreds(),c._transition(d(this)).done(function(){d(this).remove();c._trigger("failed",a,b);c._trigger("finished",a,b);e.resolve()})}):"abort"!==b.errorThrown?(b.context=c._renderUpload(b.files).appendTo(c.options.filesContainer).data("data",b),c._forceReflow(b.context),e=c._addFinishedDeferreds(),c._transition(b.context).done(function(){b.context=d(this);c._trigger("failed",a,b);c._trigger("finished",a,b);e.resolve()})):(c._trigger("failed",a,b),c._trigger("finished",
a,b),c._addFinishedDeferreds().resolve())},progress:function(a,b){if(b.context){var c=Math.floor(100*(b.loaded/b.total));b.context.find(".progress").attr("aria-valuenow",c).find(".bar").css("width",c+"%")}},progressall:function(a,b){var c=d(this),f=Math.floor(100*(b.loaded/b.total)),e=c.find(".fileupload-progress"),g=e.find(".progress-extended");g.length&&g.html((c.data("blueimp-fileupload")||c.data("fileupload"))._renderExtendedProgress(b));e.find(".progress").attr("aria-valuenow",f).find(".bar").css("width",
f+"%")},start:function(a){var b=d(this).data("blueimp-fileupload")||d(this).data("fileupload");b._resetFinishedDeferreds();b._transition(d(this).find(".fileupload-progress")).done(function(){b._trigger("started",a)})},stop:function(a){var b=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),c=b._addFinishedDeferreds();d.when.apply(d,b._getFinishedDeferreds()).done(function(){b._trigger("stopped",a)});b._transition(d(this).find(".fileupload-progress")).done(function(){d(this).find(".progress").attr("aria-valuenow",
"0").find(".bar").css("width","0%");d(this).find(".progress-extended").html("&nbsp;");c.resolve()})},destroy:function(a,b){var c=d(this).data("blueimp-fileupload")||d(this).data("fileupload");b.url&&(d.ajax(b),c._adjustMaxNumberOfFiles(1));c._transition(b.context).done(function(){d(this).remove();c._trigger("destroyed",a,b)})}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(a){a||(a=d.Deferred());this._finishedUploads.push(a);return a},_getFinishedDeferreds:function(){return this._finishedUploads},
_getFilesFromResponse:function(a){return a.result&&d.isArray(a.result.files)?a.result.files:[]},_enableDragToDesktop:function(){var a=d(this),b=a.prop("href"),c=a.prop("download");a.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",["application/octet-stream",c,b].join(":"))}catch(d){}})},_adjustMaxNumberOfFiles:function(a){"number"===typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=a,1>this.options.maxNumberOfFiles?this._disableFileInputButton():
this._enableFileInputButton())},_formatFileSize:function(a){return"number"!==typeof a?"":1E9<=a?(a/1E9).toFixed(2)+" GB":1E6<=a?(a/1E6).toFixed(2)+" MB":(a/1E3).toFixed(2)+" KB"},_formatBitrate:function(a){return"number"!==typeof a?"":1E9<=a?(a/1E9).toFixed(2)+" Gbit/s":1E6<=a?(a/1E6).toFixed(2)+" Mbit/s":1E3<=a?(a/1E3).toFixed(2)+" kbit/s":a.toFixed(2)+" bit/s"},_formatTime:function(a){var b=new Date(1E3*a);a=Math.floor(a/86400);return(a?a+"d ":"")+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+
":"+("0"+b.getUTCSeconds()).slice(-2)},_formatPercentage:function(a){return(100*a).toFixed(2)+" %"},_renderExtendedProgress:function(a){return this._formatBitrate(a.bitrate)+" | "+this._formatTime(8*(a.total-a.loaded)/a.bitrate)+" | "+this._formatPercentage(a.loaded/a.total)+" | "+this._formatFileSize(a.loaded)+" / "+this._formatFileSize(a.total)},_hasError:function(a){return a.error?a.error:0>this.options.maxNumberOfFiles?"Maximum number of files exceeded":!this.options.acceptFileTypes.test(a.type)&&
!this.options.acceptFileTypes.test(a.name)?"Filetype not allowed":this.options.maxFileSize&&a.size>this.options.maxFileSize?"File is too big":"number"===typeof a.size&&a.size<this.options.minFileSize?"File is too small":null},_validate:function(a){var b=this,c=!!a.length;d.each(a,function(a,d){d.error=b._hasError(d);d.error&&(c=!1)});return c},_renderTemplate:function(a,b){if(!a)return d();var c=a({files:b,formatFileSize:this._formatFileSize,options:this.options});return c instanceof d?c:d(this.options.templatesContainer).html(c).children()},
_renderPreview:function(a,b){var c=this,f=this.options,e=d.Deferred();return(k&&k(a,function(a){b.append(a);c._forceReflow(b);c._transition(b).done(function(){e.resolveWith(b)});d.contains(c.document[0].body,b[0])||e.resolveWith(b);b.on("remove",function(){e.resolveWith(b)})},{maxWidth:f.previewMaxWidth,maxHeight:f.previewMaxHeight,canvas:f.previewAsCanvas})||e.resolveWith(b))&&e},_renderPreviews:function(a){var b=this,c=this.options;a.context.find(".preview span").each(function(f,e){var g=a.files[f];
if(c.previewSourceFileTypes.test(g.type)&&("number"!==d.type(c.previewSourceMaxFileSize)||g.size<c.previewSourceMaxFileSize))b._processingQueue=b._processingQueue.pipe(function(){var c=d.Deferred(),f=d.Event("previewdone",{target:e});b._renderPreview(g,d(e)).done(function(){b._trigger(f.type,f,a);c.resolveWith(b)});return c.promise()})});return this._processingQueue},_renderUpload:function(a){return this._renderTemplate(this.options.uploadTemplate,a)},_renderDownload:function(a){return this._renderTemplate(this.options.downloadTemplate,
a).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(a){a.preventDefault();a=d(a.currentTarget);var b=a.closest(".template-upload").data("data");b&&(b.submit&&!b.jqXHR&&b.submit())&&a.prop("disabled",!0)},_cancelHandler:function(a){a.preventDefault();var b=d(a.currentTarget).closest(".template-upload").data("data")||{};b.jqXHR?b.jqXHR.abort():(b.errorThrown="abort",this._trigger("fail",a,b))},_deleteHandler:function(a){a.preventDefault();var b=d(a.currentTarget);this._trigger("destroy",
a,d.extend({context:b.closest(".template-download"),type:"DELETE",dataType:this.options.dataType},b.data()))},_forceReflow:function(a){return d.support.transition&&a.length&&a[0].offsetWidth},_transition:function(a){var b=d.Deferred();d.support.transition&&a.hasClass("fade")&&a.is(":visible")?a.bind(d.support.transition.end,function(c){c.target===a[0]&&(a.unbind(d.support.transition.end),b.resolveWith(a))}).toggleClass("in"):(a.toggleClass("in"),b.resolveWith(a));return b},_initButtonBarEventHandlers:function(){var a=
this.element.find(".fileupload-buttonbar"),b=this.options.filesContainer;this._on(a.find(".start"),{click:function(a){a.preventDefault();b.find(".start").click()}});this._on(a.find(".cancel"),{click:function(a){a.preventDefault();b.find(".cancel").click()}});this._on(a.find(".delete"),{click:function(c){c.preventDefault();b.find(".toggle:checked").closest(".template-download").find(".delete").click();a.find(".toggle").prop("checked",!1)}});this._on(a.find(".toggle"),{change:function(a){b.find(".toggle").prop("checked",
d(a.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar").find(".start, .cancel, .delete"),"click");this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super();this._on(this.options.filesContainer,{"click .start":this._startHandler,"click .cancel":this._cancelHandler,"click .delete":this._deleteHandler});this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();
this._off(this.options.filesContainer,"click");this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var a=this.options;a.templatesContainer=this.document[0].createElement(a.filesContainer.prop("nodeName"));h&&(a.uploadTemplateId&&(a.uploadTemplate=h(a.uploadTemplateId)),
a.downloadTemplateId&&(a.downloadTemplate=h(a.downloadTemplateId)))},_initFilesContainer:function(){var a=this.options;void 0===a.filesContainer?a.filesContainer=this.element.find(".files"):a.filesContainer instanceof d||(a.filesContainer=d(a.filesContainer))},_stringToRegExp:function(a){a=a.split("/");var b=a.pop();a.shift();return RegExp(a.join("/"),b)},_initRegExpOptions:function(){var a=this.options;"string"===d.type(a.acceptFileTypes)&&(a.acceptFileTypes=this._stringToRegExp(a.acceptFileTypes));
"string"===d.type(a.previewSourceFileTypes)&&(a.previewSourceFileTypes=this._stringToRegExp(a.previewSourceFileTypes))},_initSpecialOptions:function(){this._super();this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_setOption:function(a,b){this._super(a,b);"maxNumberOfFiles"===a&&this._adjustMaxNumberOfFiles(0)},_create:function(){this._super();this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");this._processingQueue||(this._processingQueue=
d.Deferred().resolveWith(this).promise(),this.process=function(){return this._processingQueue});this._resetFinishedDeferreds()},enable:function(){var a=!1;this.options.disabled&&(a=!0);this._super();a&&(this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton())},disable:function(){this.options.disabled||(this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton());this._super()}})});