(function(e){"function"===typeof define&&define.amd?define(["jquery","jquery.ui.widget"],e):e(window.jQuery)})(function(e){e.support.xhrFileUpload=!(!window.XMLHttpRequestUpload||!window.FileReader);e.support.xhrFormDataFileUpload=!!window.FormData;e.widget("blueimp.fileupload",{options:{dropZone:e(document),pasteZone:e(document),fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,sequentialUploads:!1,limitConcurrentUploads:void 0,forceIframeTransport:!1,
redirect:void 0,redirectParamName:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!0,formData:function(a){return a.serializeArray()},add:function(a,b){(b.autoUpload||!1!==b.autoUpload&&(e(this).data("blueimp-fileupload")||e(this).data("fileupload")).options.autoUpload)&&b.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],
_BitrateTimer:function(){this.timestamp=+new Date;this.bitrate=this.loaded=0;this.getBitrate=function(a,b,c){var d=a-this.timestamp;if(!this.bitrate||!c||d>c)this.bitrate=8*(b-this.loaded)*(1E3/d),this.loaded=b,this.timestamp=a;return this.bitrate}},_isXHRUpload:function(a){return!a.forceIframeTransport&&(!a.multipart&&e.support.xhrFileUpload||e.support.xhrFormDataFileUpload)},_getFormData:function(a){var b;return"function"===typeof a.formData?a.formData(a.form):e.isArray(a.formData)?a.formData:a.formData?
(b=[],e.each(a.formData,function(a,d){b.push({name:a,value:d})}),b):[]},_getTotal:function(a){var b=0;e.each(a,function(a,d){b+=d.size||1});return b},_initProgressObject:function(a){a._progress={loaded:0,total:0,bitrate:0}},_onProgress:function(a,b){if(a.lengthComputable){var c=+new Date,d;if(!b._time||!b.progressInterval||!(c-b._time<b.progressInterval&&a.loaded!==a.total))b._time=c,d=Math.floor(a.loaded/a.total*(b.chunkSize||b._progress.total))+(b.uploadedBytes||0),this._progress.loaded+=d-b._progress.loaded,
this._progress.bitrate=this._bitrateTimer.getBitrate(c,this._progress.loaded,b.bitrateInterval),b._progress.loaded=b.loaded=d,b._progress.bitrate=b.bitrate=b._bitrateTimer.getBitrate(c,d,b.bitrateInterval),this._trigger("progress",a,b),this._trigger("progressall",a,this._progress)}},_initProgressListener:function(a){var b=this,c=a.xhr?a.xhr():e.ajaxSettings.xhr();c.upload&&(e(c.upload).bind("progress",function(c){var e=c.originalEvent;c.lengthComputable=e.lengthComputable;c.loaded=e.loaded;c.total=
e.total;b._onProgress(c,a)}),a.xhr=function(){return c})},_initXHRData:function(a){var b,c=a.files[0],d=a.multipart||!e.support.xhrFileUpload,f=a.paramName[0];a.headers=a.headers||{};a.contentRange&&(a.headers["Content-Range"]=a.contentRange);d?e.support.xhrFormDataFileUpload&&(a.postMessage?(b=this._getFormData(a),a.blob?b.push({name:f,value:a.blob}):e.each(a.files,function(c,d){b.push({name:a.paramName[c]||f,value:d})})):(a.formData instanceof FormData?b=a.formData:(b=new FormData,e.each(this._getFormData(a),
function(a,c){b.append(c.name,c.value)})),a.blob?(a.headers["Content-Disposition"]='attachment; filename="'+encodeURI(c.name)+'"',b.append(f,a.blob,c.name)):e.each(a.files,function(c,d){if(window.Blob&&d instanceof Blob||window.File&&d instanceof File)b.append(a.paramName[c]||f,d,d.name)})),a.data=b):(a.headers["Content-Disposition"]='attachment; filename="'+encodeURI(c.name)+'"',a.contentType=c.type,a.data=a.blob||c);a.blob=null},_initIframeSettings:function(a){a.dataType="iframe "+(a.dataType||
"");a.formData=this._getFormData(a);a.redirect&&e("<a></a>").prop("href",a.url).prop("host")!==location.host&&a.formData.push({name:a.redirectParamName||"redirect",value:a.redirect})},_initDataSettings:function(a){this._isXHRUpload(a)?(this._chunkedUpload(a,!0)||(a.data||this._initXHRData(a),this._initProgressListener(a)),a.postMessage&&(a.dataType="postmessage "+(a.dataType||""))):this._initIframeSettings(a,"iframe")},_getParamName:function(a){var b=e(a.fileInput),c=a.paramName;c?e.isArray(c)||(c=
[c]):(c=[],b.each(function(){for(var a=e(this),b=a.prop("name")||"files[]",a=(a.prop("files")||[1]).length;a;)c.push(b),a-=1}),c.length||(c=[b.prop("name")||"files[]"]));return c},_initFormSettings:function(a){if(!a.form||!a.form.length)a.form=e(a.fileInput.prop("form")),a.form.length||(a.form=e(this.options.fileInput.prop("form")));a.paramName=this._getParamName(a);a.url||(a.url=a.form.prop("action")||location.href);a.type=(a.type||a.form.prop("method")||"").toUpperCase();"POST"!==a.type&&("PUT"!==
a.type&&"PATCH"!==a.type)&&(a.type="POST");a.formAcceptCharset||(a.formAcceptCharset=a.form.attr("accept-charset"))},_getAJAXSettings:function(a){a=e.extend({},this.options,a);this._initFormSettings(a);this._initDataSettings(a);return a},_getDeferredState:function(a){return a.state?a.state():a.isResolved()?"resolved":a.isRejected()?"rejected":"pending"},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var d=e.Deferred(),f=d.promise();
b=b||this.options.context||f;!0===a?d.resolveWith(b,c):!1===a&&d.rejectWith(b,c);f.abort=d.promise;return this._enhancePromise(f)},_addConvenienceMethods:function(a,b){var c=this;b.submit=function(){"pending"!==this.state()&&(b.jqXHR=this.jqXHR=!1!==c._trigger("submit",a,this)&&c._onSend(a,this));return this.jqXHR||c._getXHRPromise()};b.abort=function(){return this.jqXHR?this.jqXHR.abort():this._getXHRPromise()};b.state=function(){if(this.jqXHR)return c._getDeferredState(this.jqXHR)};b.progress=function(){return this._progress}},
_getUploadedBytes:function(a){return(a=(a=(a=a.getResponseHeader("Range"))&&a.split("-"))&&1<a.length&&parseInt(a[1],10))&&a+1},_chunkedUpload:function(a,b){var c=this,d=a.files[0],f=d.size,g=a.uploadedBytes=a.uploadedBytes||0,j=a.maxChunkSize||f,h=d.slice||d.webkitSlice||d.mozSlice,k=e.Deferred(),l=k.promise(),n,m;if(!this._isXHRUpload(a)||(!h||!(g||j<f))||a.data)return!1;if(b)return!0;if(g>=f)return d.error="Uploaded bytes exceed file size",this._getXHRPromise(!1,a.context,[null,"error",d.error]);
m=function(){var b=e.extend({},a),l=b._progress.loaded;b.blob=h.call(d,g,g+j,d.type);b.chunkSize=b.blob.size;b.contentRange="bytes "+g+"-"+(g+b.chunkSize-1)+"/"+f;c._initXHRData(b);c._initProgressListener(b);n=(!1!==c._trigger("chunksend",null,b)&&e.ajax(b)||c._getXHRPromise(!1,b.context)).done(function(d,h,j){g=c._getUploadedBytes(j)||g+b.chunkSize;b._progress.loaded===l&&c._onProgress(e.Event("progress",{lengthComputable:!0,loaded:g-b.uploadedBytes,total:g-b.uploadedBytes}),b);a.uploadedBytes=b.uploadedBytes=
g;b.result=d;b.textStatus=h;b.jqXHR=j;c._trigger("chunkdone",null,b);c._trigger("chunkalways",null,b);g<f?m():k.resolveWith(b.context,[d,h,j])}).fail(function(a,d,e){b.jqXHR=a;b.textStatus=d;b.errorThrown=e;c._trigger("chunkfail",null,b);c._trigger("chunkalways",null,b);k.rejectWith(b.context,[a,d,e])})};this._enhancePromise(l);l.abort=function(){return n.abort()};m();return l},_beforeSend:function(a,b){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer,this._progress.loaded=
this._progress.total=0,this._progress.bitrate=0);b._progress||(b._progress={});b._progress.loaded=b.loaded=b.uploadedBytes||0;b._progress.total=b.total=this._getTotal(b.files)||1;b._progress.bitrate=b.bitrate=0;this._active+=1;this._progress.loaded+=b.loaded;this._progress.total+=b.total},_onDone:function(a,b,c,d){var f=d._progress.total;d._progress.loaded<f&&this._onProgress(e.Event("progress",{lengthComputable:!0,loaded:f,total:f}),d);d.result=a;d.textStatus=b;d.jqXHR=c;this._trigger("done",null,
d)},_onFail:function(a,b,c,d){d.jqXHR=a;d.textStatus=b;d.errorThrown=c;this._trigger("fail",null,d);d.recalculateProgress&&(this._progress.loaded-=d._progress.loaded,this._progress.total-=d._progress.total)},_onAlways:function(a,b,c,d){this._active-=1;this._trigger("always",null,d);0===this._active&&this._trigger("stop")},_onSend:function(a,b){b.submit||this._addConvenienceMethods(a,b);var c=this,d,f,g,j,h=c._getAJAXSettings(b),k=function(){c._sending+=1;h._bitrateTimer=new c._BitrateTimer;return d=
d||((f||!1===c._trigger("send",a,h))&&c._getXHRPromise(!1,h.context,f)||c._chunkedUpload(h)||e.ajax(h)).done(function(a,b,d){c._onDone(a,b,d,h)}).fail(function(a,b,d){c._onFail(a,b,d,h)}).always(function(a,b,d){c._sending-=1;c._onAlways(a,b,d,h);if(h.limitConcurrentUploads&&h.limitConcurrentUploads>c._sending)for(a=c._slots.shift();a;){if("pending"===c._getDeferredState(a)){a.resolve();break}a=c._slots.shift()}})};this._beforeSend(a,h);return this.options.sequentialUploads||this.options.limitConcurrentUploads&&
this.options.limitConcurrentUploads<=this._sending?(1<this.options.limitConcurrentUploads?(g=e.Deferred(),this._slots.push(g),j=g.pipe(k)):j=this._sequence=this._sequence.pipe(k,k),j.abort=function(){f=[void 0,"abort","abort"];return!d?(g&&g.rejectWith(h.context,f),k()):d.abort()},this._enhancePromise(j)):k()},_onAdd:function(a,b){var c=this,d=!0,f=e.extend({},this.options,b),g=f.limitMultiFileUploads,j=this._getParamName(f),h,k,l;if(!f.singleFileUploads&&!g||!this._isXHRUpload(f))k=[b.files],h=[j];
else if(!f.singleFileUploads&&g){k=[];h=[];for(l=0;l<b.files.length;l+=g)k.push(b.files.slice(l,l+g)),f=j.slice(l,l+g),f.length||(f=j),h.push(f)}else h=j;b.originalFiles=b.files;e.each(k||b.files,function(f,g){var j=e.extend({},b);j.files=k?g:[g];j.paramName=h[f];c._initProgressObject(j);c._addConvenienceMethods(a,j);return d=c._trigger("add",a,j)});return d},_replaceFileInput:function(a){var b=a.clone(!0);e("<form></form>").append(b)[0].reset();a.after(b).detach();e.cleanData(a.unbind("remove"));
this.options.fileInput=this.options.fileInput.map(function(c,d){return d===a[0]?b[0]:d});a[0]===this.element[0]&&(this.element=b)},_handleFileTreeEntry:function(a,b){var c=this,d=e.Deferred(),f=function(b){b&&!b.entry&&(b.entry=a);d.resolve([b])},g;b=b||"";a.isFile?a._file?(a._file.relativePath=b,d.resolve(a._file)):a.file(function(a){a.relativePath=b;d.resolve(a)},f):a.isDirectory?(g=a.createReader(),g.readEntries(function(e){c._handleFileTreeEntries(e,b+a.name+"/").done(function(a){d.resolve(a)}).fail(f)},
f)):d.resolve([]);return d.promise()},_handleFileTreeEntries:function(a,b){var c=this;return e.when.apply(e,e.map(a,function(a){return c._handleFileTreeEntry(a,b)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(a){a=a||{};var b=a.items;return b&&b.length&&(b[0].webkitGetAsEntry||b[0].getAsEntry)?this._handleFileTreeEntries(e.map(b,function(a){var b;if(a.webkitGetAsEntry){if(b=a.webkitGetAsEntry())b._file=a.getAsFile();return b}return a.getAsEntry()})):
e.Deferred().resolve(e.makeArray(a.files)).promise()},_getSingleFileInputFiles:function(a){a=e(a);var b=a.prop("webkitEntries")||a.prop("entries");if(b&&b.length)return this._handleFileTreeEntries(b);b=e.makeArray(a.prop("files"));if(b.length)void 0===b[0].name&&b[0].fileName&&e.each(b,function(a,b){b.name=b.fileName;b.size=b.fileSize});else{a=a.prop("value");if(!a)return e.Deferred().resolve([]).promise();b=[{name:a.replace(/^.*\\/,"")}]}return e.Deferred().resolve(b).promise()},_getFileInputFiles:function(a){return!(a instanceof
e)||1===a.length?this._getSingleFileInputFiles(a):e.when.apply(e,e.map(a,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_onChange:function(a){var b=this,c={fileInput:e(a.target),form:e(a.target.form)};this._getFileInputFiles(c.fileInput).always(function(d){c.files=d;b.options.replaceFileInput&&b._replaceFileInput(c.fileInput);!1!==b._trigger("change",a,c)&&b._onAdd(a,c)})},_onPaste:function(a){var b=a.originalEvent.clipboardData,c={files:[]};e.each(b&&
b.items||[],function(a,b){var e=b.getAsFile&&b.getAsFile();e&&c.files.push(e)});if(!1===this._trigger("paste",a,c)||!1===this._onAdd(a,c))return!1},_onDrop:function(a){var b=this,c=a.dataTransfer=a.originalEvent.dataTransfer,d={};c&&(c.files&&c.files.length)&&a.preventDefault();this._getDroppedFiles(c).always(function(c){d.files=c;!1!==b._trigger("drop",a,d)&&b._onAdd(a,d)})},_onDragOver:function(a){var b=a.dataTransfer=a.originalEvent.dataTransfer;if(!1===this._trigger("dragover",a))return!1;b&&
-1!==e.inArray("Files",b.types)&&(b.dropEffect="copy",a.preventDefault())},_initEventHandlers:function(){this._isXHRUpload(this.options)&&(this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop}),this._on(this.options.pasteZone,{paste:this._onPaste}));this._on(this.options.fileInput,{change:this._onChange})},_destroyEventHandlers:function(){this._off(this.options.dropZone,"dragover drop");this._off(this.options.pasteZone,"paste");this._off(this.options.fileInput,"change")},_setOption:function(a,
b){var c=-1!==e.inArray(a,this._refreshOptionsList);c&&this._destroyEventHandlers();this._super(a,b);c&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var a=this.options;void 0===a.fileInput?a.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]'):a.fileInput instanceof e||(a.fileInput=e(a.fileInput));a.dropZone instanceof e||(a.dropZone=e(a.dropZone));a.pasteZone instanceof e||(a.pasteZone=e(a.pasteZone))},_create:function(){e.extend(this.options,
e(this.element[0].cloneNode(!1)).data());this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(!0);this._sending=this._active=0;this._initProgressObject(this);this._initEventHandlers()},progress:function(){return this._progress},add:function(a){var b=this;a&&!this.options.disabled&&(a.fileInput&&!a.files?this._getFileInputFiles(a.fileInput).always(function(c){a.files=c;b._onAdd(null,a)}):(a.files=e.makeArray(a.files),this._onAdd(null,a)))},send:function(a){if(a&&!this.options.disabled){if(a.fileInput&&
!a.files){var b=this,c=e.Deferred(),d=c.promise(),f,g;d.abort=function(){g=!0;if(f)return f.abort();c.reject(null,"abort","abort");return d};this._getFileInputFiles(a.fileInput).always(function(d){g||(a.files=d,f=b._onSend(null,a).then(function(a,b,d){c.resolve(a,b,d)},function(a,b,d){c.reject(a,b,d)}))});return this._enhancePromise(d)}a.files=e.makeArray(a.files);if(a.files.length)return this._onSend(null,a)}return this._getXHRPromise(!1,a&&a.context)}})});